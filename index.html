<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image Recognition Chatbot</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f9f9f9;
    }
    #chatbox {
      border: 1px solid #ccc;
      padding: 20px;
      background: #fff;
      max-width: 500px;
    }
    #messages {
      margin-bottom: 20px;
      min-height: 50px;
    }
    .message {
      margin: 5px 0;
    }
    .bot {
      color: #2c3e50;
      font-weight: bold;
    }
    .user {
      color: #16a085;
    }
  </style>
</head>
<body>
  <h2>Image Recognition Chatbot</h2>
  <div id="chatbox">
    <div id="messages"></div>
    <input type="file" id="imageInput" accept="image/*">
    <button onclick="sendImage()">Send Image</button>
  </div>

  <script>
    async function sendImage() {
      const fileInput = document.getElementById('imageInput');
      const file = fileInput.files[0];
      if (!file) {
        alert("Please select an image first.");
        return;
      }

      // Show user message
      const messages = document.getElementById('messages');
      const userMsg = document.createElement('div');
      userMsg.className = 'message user';
      userMsg.textContent = "You uploaded: " + file.name;
      messages.appendChild(userMsg);

      // Prepare form data
      const formData = new FormData();
      formData.append("image", file);

      try {
        const response = await fetch("https://api.imagga.com/v2/tags", {
          method: "POST",
          headers: {
            "Authorization": "Basic " + btoa("acc_7c2ba56e833b27b:5b186a166b11692b60146c913efcdddb") // placeholder
          },
          body: formData
        });

        const data = await response.json();

        if (data.result && data.result.tags && data.result.tags.length > 0) {
          // Sort tags by confidence
          const sorted = data.result.tags.sort((a, b) => b.confidence - a.confidence);
          const bestTag = sorted[0].tag.en;

          const botMsg = document.createElement('div');
          botMsg.className = 'message bot';
          botMsg.textContent = "Imagga: I think this is a " + bestTag;
          messages.appendChild(botMsg);

            const nutritionInfo = await fetchNutrition(bestTag);
            const botMsg2 = document.createElement('div');
            botMsg2.className = 'message bot';
            botMsg2.textContent = "Nutrition facts: " + nutritionInfo;
            messages.appendChild(botMsg2);
        } else {
          const botMsg = document.createElement('div');
          botMsg.className = 'message bot';
          botMsg.textContent = "Bot: Sorry, I couldn't recognize that.";
          messages.appendChild(botMsg);
        }
      } catch (err) {
        console.error(err);
        const botMsg = document.createElement('div');
        botMsg.className = 'message bot';
        botMsg.textContent = "Bot: Error connecting to Imagga API.";
        messages.appendChild(botMsg);

        const nutritionInfo = await fetchNutrition(bestTag);

        const botMsg2 = document.createElement('div');
        botMsg2.className = 'message bot';
        botMsg2.textContent = "Nutrition facts: " + nutritionInfo;
        messages.appendChild(botMsg2);

      }
    }

    async function fetchNutrition(foodName) {
  try {
    const response = await fetch(
      `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(foodName)}&api_key=RpAcmnyw2tz1pQp7m38vjDZCy5Q4OYMSu3zes3RM`
    );
    const data = await response.json();

    if (data.foods && data.foods.length > 0) {
      const food = data.foods[0]; // take the first match
      const nutrients = food.foodNutrients;

      // Extract some common nutrients
      const calories = nutrients.find(n => n.nutrientName === "Energy")?.value;
      const protein = nutrients.find(n => n.nutrientName === "Protein")?.value;
      const fat = nutrients.find(n => n.nutrientName === "Total lipid (fat)")?.value;
      const carbs = nutrients.find(n => n.nutrientName === "Carbohydrate, by difference")?.value;

      return `Calories: ${calories} kcal, Protein: ${protein} g, Fat: ${fat} g, Carbs: ${carbs} g (per 100g)`;
    } else {
      return "No nutrition facts found.";
    }
  } catch (err) {
    console.error(err);
    return "Error fetching nutrition facts.";
  }
}
  </script>
</body>
</html>
